<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f9;
      overflow: hidden;
    }

    .container {
      position: relative;
      width: 100%;
      max-width: 470px;
      display: flex;
      flex-direction: column;
    }

    .card {
      position: absolute;
      width: 100%;
      height: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transform-origin: center;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      gap: 25px
    }

    .card img {
      max-width: 90%;
      height: auto;
      border-radius: 10px;
    }

    .card h3 {
      padding-left: 1em;
      padding-right: 1em;
      font-size: clamp(20px, 10vw, 32px);
    }

    .card.hidden {
      display: none;
    }

    .card.like {
      border: 3px solid #4caf50;
    }

    .card.dislike {
      border: 3px solid #f44336;
    }

    #card-stack {
      position: relative;
      width: 60%;
      height: auto;
      align-self: center;
      aspect-ratio: 9/16;
    }

    .button-container {
      display: flex;
      justify-content: space-around;
      margin-top: 6em;
    }

    .button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      padding: 10px 20px;
      border-radius: 5px;
      transition: transform 0.2s;
    }

    #dislike-button {
      background-color: #f44336;
      color: white;
    }

    #like-button {
      background-color: #4caf50;
      color: white;
    }

    .button:hover {
      transform: scale(1.1);
    }

    #skip-button {
      background-color: #9e9e9e;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 16px;
    }

    #skip-button i {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="card-stack"></div>
    <div class="button-container">
      <button class="button" id="dislike-button"><i class="icon fas fa-thumbs-down"></i></button>
      <button class="button" id="skip-button">
        <i class="icon fas fa-forward"></i>
        <span>Skip</span>
      </button>
      <button class="button" id="like-button"><i class="icon fas fa-heart"></i></button>
    </div>
  </div>
  <script>
    const likedItems = [];
    const dislikedItems = [];

    const cardsData = [
      {
        img: 'https://picsum.photos/id/12/300',
        title: 'Item #1 Title',
        name: 'item_1',
      },
      {
        img: 'https://picsum.photos/id/15/300',
        title: 'Item #2 Title',
        name: 'item_2',
      },
      {
        img: 'https://picsum.photos/id/29/300',
        title: 'Item #3 Title',
        name: 'item_3',
      },
      {
        img: 'https://picsum.photos/id/27/300',
        title: 'Item #4 Title',
        name: 'item_4',
      },
    ];

    const cardStack = document.getElementById('card-stack');

    function createCards(data) {
      data.reverse().forEach((item) => {
        const card = document.createElement('div');
        card.classList.add('card');
        card.setAttribute('data-name', item.name);
        card.innerHTML = `
          <img src="${item.img}" alt="${item.title}">
          <h3>${item.title}</h3>
        `;
        cardStack.appendChild(card);

        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false; // Track if the card is being dragged

        card.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isDragging = true; // Set dragging to true
          offsetX = e.touches[0].clientX - card.offsetLeft;
          offsetY = e.touches[0].clientY - card.offsetTop;
          card.style.transition = 'none';
          document.addEventListener('touchmove', moveCard);
          document.addEventListener('touchend', releaseCard);
        });

        card.addEventListener('pointerdown', (e) => {
          isDragging = true; // Set dragging to true
          offsetX = e.clientX - card.offsetLeft;
          offsetY = e.clientY - card.offsetTop;
          card.style.transition = 'none';
          document.addEventListener('pointermove', moveCard);
          document.addEventListener('pointerup', releaseCard);
        });

        function moveCard(e) {
          if (!isDragging) return; // Only move if dragging is true

          const image = card.querySelector('img');
          const title = card.querySelector('h3');
          image.style.pointerEvents = 'none';
          title.style.pointerEvents = 'none';

          let moveX, moveY;
          if (e.touches) {
            moveX = e.touches[0].clientX - offsetX;
            moveY = e.touches[0].clientY - offsetY;
          } else {
            moveX = e.clientX - offsetX;
            moveY = e.clientY - offsetY;
          }
          
          card.style.transform = `translate(${moveX}px, ${moveY}px) rotate(${moveX / 10}deg)`;
        }

        function releaseCard(e) {
          isDragging = false; // Reset dragging to false

          let moveX;
          if (e.changedTouches) {
            moveX = e.changedTouches[0].clientX - offsetX;
          } else {
            moveX = e.clientX - offsetX;
          }

          let action = null;

          const cardName = card.getAttribute('data-name');
          if (moveX > 150) {
            card.classList.add('like');
            likedItems.push(cardName);
          } else if (moveX < -150) {
            card.classList.add('dislike');
            dislikedItems.push(cardName);
          }

          if(moveX > 150 || moveX < -150) {
              setTimeout(() => {
                card.remove();
                if (cardStack.children.length === 0) {
                  logAndCloseBraze();
                }
              }, 300);
          } else {
            card.style.transform = 'translate(0, 0)';
            card.style.transition = 'transform 0.3s ease-out';
          }

          // Remove event listeners after release
          document.removeEventListener('touchmove', moveCard);
          document.removeEventListener('touchend', releaseCard);
          document.removeEventListener('pointermove', moveCard);
          document.removeEventListener('pointerup', releaseCard);
        }
      });
    }

    function logAndCloseBraze() {
      brazeBridge.getUser().setCustomUserAttribute("liked_items", likedItems);	
      brazeBridge.getUser().setCustomUserAttribute("disliked_items", dislikedItems);	
      brazeBridge.closeMessage();
    }

    function handleCardRemoval(card, action) {
      const cardName = card.getAttribute('data-name');
      if (action === 'like') {
        card.classList.add('like');
        likedItems.push(cardName);
      } else if (action === 'dislike') {
        card.classList.add('dislike');
        dislikedItems.push(cardName);
      }
      
      setTimeout(() => {
        card.remove();
        if (cardStack.children.length === 0) {
          logAndCloseBraze();
        }
      }, 300);
    }

    const likeButton = document.getElementById('like-button');
    const dislikeButton = document.getElementById('dislike-button');

    likeButton.addEventListener('click', () => {
      const topCard = cardStack.lastElementChild;
      if (topCard) {
        handleCardRemoval(topCard, 'like');
      }
    });

    dislikeButton.addEventListener('click', () => {
      const topCard = cardStack.lastElementChild;
      if (topCard) {
        handleCardRemoval(topCard, 'dislike');
      }
    });
    
    const skipButton = document.getElementById('skip-button');

    skipButton.addEventListener('click', () => {
      const topCard = cardStack.lastElementChild;
      if (topCard) {
        topCard.remove();
        if (cardStack.children.length === 0) {
          logAndCloseBraze();
        }
      }
    });

    createCards(cardsData);
  </script>
</body>
</html>